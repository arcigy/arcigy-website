// Language Data
const translations = {
    en: {
        nav: {
            home: "Home",
            about: "About",
            services: "Services",
            pricing: "Pricing",
            contact: "Contact"
        },
        hero: {
            title: "Last step to business arc.",
            subtitle: "We identify and automate core business processes—from lead generation and quality control to logistics and internal operations—to unlock significant growth.",
            cta: {
                primary: "Diagnose & Automate",
                secondary: "Explore Solutions"
            }
        },
        problems: {
            title: "Key Business Problems We Solve",
            card1: {
                title: "Inefficient Lead Flow",
                desc: "Manual lead qualification creates bottlenecks and missed opportunities in your sales pipeline."
            },
            card2: {
                title: "High Operational Costs",
                desc: "Repetitive manual tasks consume resources and prevent scaling without proportional cost increases."
            },
            card3: {
                title: "Inconsistent Quality Control",
                desc: "Human error in quality checks leads to inconsistencies and customer dissatisfaction."
            }
        },
        services: {
            title: "Our Automation Solutions",
            item1: {
                title: "Process Audit & Optimization",
                desc: "Comprehensive analysis of your current workflows to identify automation opportunities and efficiency gaps."
            },
            item2: {
                title: "Intelligent Lead Qualification & Management",
                desc: "Automated systems that score, route, and nurture leads through your sales funnel with precision."
            },
            item3: {
                title: "Supply Chain & Logistics Automation",
                desc: "Streamline inventory management, order processing, and delivery coordination with smart automation."
            },
            item4: {
                title: "Automated Quality Assurance Checks",
                desc: "Consistent quality control through automated validation, testing, and compliance monitoring."
            },
            item5: {
                title: "Smart Assistant Integration",
                desc: "Deploy intelligent call agents and virtual assistants to handle customer interactions and internal tasks."
            },
            cta: "Learn More About Our Services"
        },
        howitworks: {
            title: "How It Works",
            step1: {
                title: "Diagnose",
                desc: "We analyze your business processes to identify inefficiencies and automation opportunities."
            },
            step2: {
                title: "Design",
                desc: "We create custom automation solutions tailored to your specific business needs and goals."
            },
            step3: {
                title: "Deploy",
                desc: "We implement and monitor your automation systems, ensuring smooth integration and optimal performance."
            }
        },
        pricing: {
            title: "Pricing Plans",
            badge: "All Inclusive",
            basic: {
                name: "Core Efficiency",
                feature1: "Automates key bottlenecks for immediate impact",
                feature2: "Streamlines essential workflows",
                feature3: "Standard integration package",
                feature4: "Ideal for focused improvements",
                cta: "Schedule Meeting"
            },
            premium: {
                name: "Total Transformation",
                feature1: "Complete end-to-end business automation",
                feature2: "AI-driven architecture & scalability",
                feature3: "Unlimited custom integrations",
                feature4: "Dedicated 24/7 optimization & support",
                cta: "Schedule Meeting"
            },
            audit: {
                title: "AI Business Audit",
                price: "€500",
                desc: "The perfect starting point. We analyze your infrastructure to find where automation yields the highest returns.",
                feature1: "Full Workflow Mapping",
                feature2: "Bottleneck Analysis",
                feature3: "Custom Automation Strategy",
                feature4: "ROI Projection",
                cta: "Book Audit"
            },
            cta: "Schedule Meeting",
            note: "Our pricing is performance-based. We charge a percentage of the value generated or costs saved, determined after a comprehensive audit."
        },
        aboutpreview: {
            title: "About ArciGy",
            text: "We are automation architects dedicated to solving systemic business problems through intelligent automation. Our mission is to help businesses achieve predictable growth by identifying and automating core processes that drive efficiency and scalability.",
            cta: "Learn More About ArciGy"
        },
        contact: {
            title: "Get Started Today",
            form: {
                forename: "Forename",
                surname: "Surname",
                company: "Company",
                email: "Email",
                phone: "Phone",
                summary: "Project Summary (focus on the problem you need to solve)",
                terms: 'I agree to the <a href="terms-of-service.html" target="_blank">Terms of Service</a>',
                privacy: 'I agree to the <a href="privacy-policy.html" target="_blank">Privacy Policy</a>',
                submit: "Send a Proposal"
            },
            privacy: "Your data is safe. We do not share it with third parties."
        },
        audit: {
            hero: {
                title: "AI Business Audit",
                subtitle: "Tell us about your business to get started"
            },
            form: {
                fullname: "Full Name",
                email: "Email",
                phone: "Phone Number (please include prefix, e.g. +421)",
                pitch: "Short description of your business (what you do and for whom)",
                turnover: "Annual Turnover",
                select_option: "Select an option",
                journey: "What's your customer journey? (Walk me through your business from click to close)",
                dream: "What's your dream outcome?",
                problem: "What's your biggest problem right now?",
                bottleneck: "Based on your good feeling, what do you think the biggest bottleneck is right now?",
                submit: "Select Date"
            }
        },
        footer: {
            tagline: "Automation Architects for Business Efficiency",
            links: {
                title: "Quick Links"
            },
            legal: {
                title: "Legal",
                terms: "Terms of Service",
                privacy: "Privacy Policy"
            },
            newsletter: {
                title: "Newsletter",
                placeholder: "Your email",
                submit: "Subscribe"
            },
            copyright: "© 2024 ArciGy. All rights reserved."
        }
    },
    sk: {
        nav: {
            home: "Domov",
            about: "O nás",
            services: "Služby",
            pricing: "Cenník",
            contact: "Kontakt"
        },
        hero: {
            title: "Last step to business arc.",
            subtitle: "Identifikujeme a automatizujeme kľúčové firemné procesy—od generovania leadov a kontroly kvality po logistiku a interné operácie—pre odomknutie signifikantného rastu.",
            cta: {
                primary: "Diagnostika a Automatizácia",
                secondary: "Preskúmaj riešenia"
            }
        },
        problems: {
            title: "Kľúčové Firemné Problémy, Ktoré Riešime",
            card1: {
                title: "Neefektívny Tok Leadov",
                desc: "Manuálna kvalifikácia leadov vytvára úzke miesta a premárnené príležitosti vo vašom predajnom procese."
            },
            card2: {
                title: "Vysoké Prevádzkové Náklady",
                desc: "Opakujúce sa manuálne úlohy spotrebúvajú zdroje a bránia škálovaniu bez proporcionálneho zvýšenia nákladov."
            },
            card3: {
                title: "Nekonzistentná Kontrola Kvality",
                desc: "Ľudská chyba pri kontrolách kvality vedie k nekonzistenciám a nespokojnosti zákazníkov."
            }
        },

        process: {
            title: "Náš Proces",
            step1: {
                title: "Audit",
                desc: "Mapujeme vaše procesy a toky dát, aby sme odhalili slabé miesta."
            },
            step2: {
                title: "Analýza",
                desc: "Kvantifikujeme dopad a navrhneme optimálny prístup k automatizácii."
            },
            step3: {
                title: "Implementácia",
                desc: "Nasadzujeme inteligentné systémy a integrujeme ich do vašej technologickej sady."
            },
            step4: {
                title: "Optimalizácia",
                desc: "Monitorujeme, ladíme a rozširujeme automatizáciu pre neustály nárast návratnosti investícií (ROI)."
            }
        },
        services: {
            title: "Naše Automatizačné Riešenia",
            item1: {
                title: "Audit a Optimalizácia Procesov",
                desc: "Komplexná analýza vašich súčasných pracovných postupov na identifikáciu príležitostí pre automatizáciu a medzier v efektivite."
            },
            item2: {
                title: "Inteligentná Kvalifikácia a Správa Leadov",
                desc: "Automatizované systémy, ktoré hodnotia, smerujú a starajú sa o leady vo vašom predajnom lieviku s presnosťou."
            },
            item3: {
                title: "Automatizácia Dodávateľského Reťazca a Logistiky",
                desc: "Zefektívnite správu zásob, spracovanie objednávok a koordináciu dodávok pomocou inteligentnej automatizácie."
            },
            item4: {
                title: "Automatizované Kontroly Kvality",
                desc: "Konzistentná kontrola kvality prostredníctvom automatizovanej validácie, testovania a monitorovania súladu."
            },
            item5: {
                title: "Integrácia Inteligentných Asistentov",
                desc: "Nasadenie inteligentných hovorcových agentov a virtuálnych asistentov na spracovanie zákazníckych interakcií a interných úloh."
            },
            cta: "Dozvedieť sa viac o našich službách"
        },
        howitworks: {
            title: "Ako to Funguje",
            step1: {
                title: "Diagnostika",
                desc: "Analyzujeme vaše firemné procesy na identifikáciu neefektívností a príležitostí pre automatizáciu."
            },
            step2: {
                title: "Dizajn",
                desc: "Vytvárame vlastné automatizačné riešenia prispôsobené vašim špecifickým firemným potrebám a cieľom."
            },
            step3: {
                title: "Nasadenie",
                desc: "Implementujeme a monitorujeme vaše automatizačné systémy, zabezpečujúc plynulú integráciu a optimálny výkon."
            }
        },
        pricing: {
            title: "Cenníkové Plány",
            badge: "All Inclusive",
            basic: {
                name: "Základná Efektivita",
                feature1: "Automatizácia kľúčových úzkych miest pre okamžitý dopad",
                feature2: "Zefektívnenie základných pracovných tokov",
                feature3: "Štandardný balík integrácií",
                feature4: "Ideálne pre cielené vylepšenia",
                cta: "Dohodnite si Stretnutie"
            },
            premium: {
                name: "Totálna Transformácia",
                feature1: "Kompletná automatizácia všetkých firemných procesov",
                feature2: "Architektúra riadená AI a neobmedzená škálovateľnosť",
                feature3: "Neobmedzené vlastné integrácie",
                feature4: "Dedikovaná optimalizácia a podpora 24/7",
                cta: "Dohodnite si Stretnutie"
            },
            audit: {
                title: "Vstupný AI Audit",
                price: "500 €",
                desc: "Ideálny záchytný bod. Analyzujeme vašu infraštruktúru, aby sme našli miesta, kde automatizácia prinesie najvyššiu návratnosť.",
                feature1: "Kompletné mapovanie workflow",
                feature2: "Analýza úzkych miest",
                feature3: "Vlastná automatizačná stratégia",
                feature4: "Projekcia ROI",
                cta: "Objednať Audit"
            },
            cta: "Dohodnite si Stretnutie",
            note: "Naša cena je založená na výkone. Účtujeme si percento z vygenerovanej hodnoty alebo ušetrených nákladov, ktoré určíme po dôkladnom audite."
        },
        aboutpreview: {
            title: "O ArciGy",
            text: "Sme architekti automatizácie venovaní riešeniu systémových firemných problémov prostredníctvom inteligentnej automatizácie. Našou misiou je pomôcť firmám dosiahnuť predvídateľný rast identifikáciou a automatizáciou kľúčových procesov, ktoré poháňajú efektivitu a škálovateľnosť.",
            cta: "Dozvedieť sa viac o ArciGy"
        },
        contact: {
            title: "Začnite Ešte Dnes",
            form: {
                forename: "Meno",
                surname: "Priezvisko",
                company: "Spoločnosť",
                email: "Email",
                phone: "Telefón",
                summary: "Zhrnutie projektu (zamerajte sa na problém, ktorý potrebujete vyriešiť)",
                terms: 'Súhlasím s <a href="terms-of-service.html" target="_blank">Obchodnými podmienkami</a>',
                privacy: 'Súhlasím so <a href="privacy-policy.html" target="_blank">Zásadami ochrany osobných údajov</a>',
                submit: "Odoslať návrh"
            },
            privacy: "Vaše údaje sú bezpečné. Nepreposielame ich tretím stranám."
        },
        audit: {
            hero: {
                title: "AI Business Audit",
                subtitle: "Povedzte nám o vašom podnikaní, aby sme mohli začať"
            },
            form: {
                fullname: "Celé meno",
                email: "Email",
                phone: "Telefónne číslo (vkladajte aj s predvoľbou napr. +421)",
                pitch: "Stručný popis vášho podnikania (čo robíte a pre koho)",
                turnover: "Ročný obrat",
                select_option: "Vyberte možnosť",
                journey: "Aká je cesta vášho zákazníka? (Preveďte ma vaším podnikaním od kliknutia po uzavretie obchodu)",
                dream: "Aký je váš vysnívaný výsledok?",
                problem: "Aký je váš najväčší problém práve teraz?",
                bottleneck: "Na základe vášho pocitu, čo si myslíte, že je teraz najväčším úzkym miestom?",
                submit: "Vybrať termín"
            }
        },
        footer: {
            tagline: "Architekti Automatizácie pre Firemnú Efektivitu",
            links: {
                title: "Rýchle odkazy"
            },
            legal: {
                title: "Právne",
                terms: "Obchodné podmienky",
                privacy: "Zásady ochrany súkromia"
            },
            newsletter: {
                title: "Newsletter",
                placeholder: "Váš email",
                submit: "Prihlásiť sa"
            },
            copyright: "© 2024 ArciGy. Všetky práva vyhradené."
        },
        about: {
            hero: {
                title: "O ArciGy",
                subtitle: "Architekti Automatizácie pre Predvídateľný Rast"
            },
            story: {
                title: "Náš Príbeh",
                p1: "ArciGy bolo založené s jasnou misiou: pomôcť firmám odomknúť ich plný potenciál prostredníctvom inteligentnej automatizácie. Rozpoznali sme, že mnohé spoločnosti bojujú so systémovými neefektívnosťami, ktoré bránia rastu a škálovateľnosti.",
                p2: "Náš tím automatizačných architektov kombinuje hlbokú technickú odbornosť s obchodnou zručnosťou na identifikáciu a riešenie kľúčových prevádzkových výziev. Neimplementujeme len technológiu—prepracovávame procesy pre maximálnu efektivitu.",
                p3: "Dnes pracujeme s firmami naprieč odvetviami, od výroby po služby, pomáhajúc im dosiahnuť predvídateľný rast prostredníctvom stratégickej automatizácie."
            },
            mission: {
                title: "Naša Misia",
                text: "Automatizácia pre Predvídateľný Rast. Veríme, že každá firma si zaslúži fungovať na špičkovej efektivite. Našou misiou je identifikovať systémové problémy a riešiť ich prostredníctvom inteligentnej automatizácie, umožňujúc našim klientom škálovať bez proporcionálneho zvýšenia nákladov."
            },
            values: {
                title: "Naše Hodnoty",
                precision: {
                    title: "Presnosť",
                    desc: "Každé automatizačné riešenie je dôkladne navrhnuté a otestované na zabezpečenie spoľahlivosti a presnosti."
                },
                scalability: {
                    title: "Škálovateľnosť",
                    desc: "Staviame systémy, ktoré rastú s vašou firmou, nie také, ktoré potrebujú neustále prepracovanie."
                },
                innovation: {
                    title: "Inovácia",
                    desc: "Zostávame v popredí automatizačnej technológie na poskytovanie najmodernejších riešení."
                },
                partnership: {
                    title: "Partnerstvo",
                    desc: "Váš úspech je náš úspech. Pracujeme ako rozšírenie vášho tímu, nie len ako dodávateľ."
                }
            },
            team: {
                title: "Náš Tím",
                intro: "Náš tím pozostáva z automatizačných architektov, procesných inžinierov a obchodných analytikov, ktorí spolupracujú na poskytovaní výnimočných výsledkov.",
                role1: {
                    title: "Automatizační Architekti",
                    desc: "Navrhujú a implementujú inteligentné automatizačné systémy pre firemných klientov."
                },
                role2: {
                    title: "Procesní Inžinieri",
                    desc: "Analyzujú firemné procesy a identifikujú príležitosti pre automatizáciu."
                },
                role3: {
                    title: "Obchodný Analytik",
                    desc: "Spájajte medzeru medzi firemnými požiadavkami a technickými riešeniami."
                }
            },
        },
        servicespage: {
            hero: {
                title: "Naše Služby",
                subtitle: "Komplexné Riešenia Pre Automatizáciu Podnikania"
            },
            category1: {
                title: "Automatizácia Predaja a Marketingu",
                desc: "Transformujte svoje predajné a marketingové procesy pomocou inteligentnej automatizácie, ktorá kvalifikuje leady, stará sa o potenciálnych zákazníkov a optimalizuje konverzné miery."
            },
            category2: {
                title: "Prevádzková Efektivita",
                desc: "Zefektívnite interné operácie, znížte manuálnu prácu a odstráňte úzke miesta prostredníctvom automatizácie procesov."
            },
            category3: {
                title: "Dodávateľský Reťazec a Logistika",
                desc: "Optimalizujte správu zásob, spracovanie objednávok a koordináciu dodávok pomocou inteligentných automatizačných systémov."
            },
            flow: {
                title: "Ukážka Automatizačného Toku",
                item1: "Automatizovaný zber leadov z viacerých kanálov",
                item2: "Inteligentné hodnotenie a kvalifikácia leadov",
                item3: "Automatizované smerovanie na príslušný predajný tím",
                item4: "Sekvencie sledovania a kampane starostlivosti",
                item5: "Sledovanie výkonnosti a optimalizácia"
            },
            flow2: {
                item1: "Audit procesov a identifikácia úzkych miest",
                item2: "Prepracovanie a optimalizácia pracovných postupov",
                item3: "Automatizované priradenie a sledovanie úloh",
                item4: "Integrácia so súčasnými systémami",
                item5: "Neustále monitorovanie a zlepšovanie"
            },
            flow3: {
                item1: "Automatizované monitorovanie zásob a upozornenia",
                item2: "Automatizácia spracovania a plnenia objednávok",
                item3: "Plánovanie a sledovanie dodávok",
                item4: "Automatizácia komunikácie so dodávateľmi",
                item5: "Správy a analýzy v reálnom čase"
            },
            cta: {
                title: "Ste Pripravení Automatizovať Svoju Firmu?",
                text: "Požiadajte o konzultáciu a zistite, ako môže automatizácia transformovať vaše operácie.",
                button: "Vyžiadať Konzultáciu"
            }
        },
        pricingpage: {
            hero: {
                title: "Cenníkové Plány",
                subtitle: "Vyberte si automatizačné riešenie, ktoré vyhovuje vašim firemným potrebám"
            },
            toggle: {
                monthly: "Mesačne",
                annual: "Ročne"
            },
            enterprise: {
                cta: "Dohodnite si Stretnutie"
            }
        },
        contactpage: {
            hero: {
                title: "Začnite Ešte Dnes",
                subtitle: "Poďme diskutovať o tom, ako môže automatizácia transformovať vašu firmu"
            }
        }
    }
};

// Add additional page translations to English
translations.en.about = {
    hero: {
        title: "About ArciGy",
        subtitle: "Automation Architects for Predictable Growth"
    },
    story: {
        title: "Our Story",
        p1: "ArciGy was founded with a clear mission: to help businesses unlock their full potential through intelligent automation. We recognized that many companies struggle with systemic inefficiencies that prevent growth and scalability.",
        p2: "Our team of automation architects combines deep technical expertise with business acumen to identify and solve core operational challenges. We don't just implement technology—we redesign processes for maximum efficiency.",
        p3: "Today, we work with businesses across industries, from manufacturing to services, helping them achieve predictable growth through strategic automation."
    },
    mission: {
        title: "Our Mission",
        text: "Automation for Predictable Growth. We believe that every business deserves to operate at peak efficiency. Our mission is to identify systemic problems and solve them through intelligent automation, enabling our clients to scale without proportional cost increases."
    },
    values: {
        title: "Our Values",
        precision: {
            title: "Precision",
            desc: "Every automation solution is meticulously designed and tested to ensure reliability and accuracy."
        },
        scalability: {
            title: "Scalability",
            desc: "We build systems that grow with your business, not ones that need constant rework."
        },
        innovation: {
            title: "Innovation",
            desc: "We stay at the forefront of automation technology to deliver cutting-edge solutions."
        },
        partnership: {
            title: "Partnership",
            desc: "Your success is our success. We work as an extension of your team, not just a vendor."
        }
    },
    team: {
        title: "Our Team",
        intro: "Our team consists of automation architects, process engineers, and business analysts who work together to deliver exceptional results.",
        role1: {
            title: "Automation Architects",
            desc: "Design and implement intelligent automation systems tailored to your business needs."
        },
        role2: {
            title: "Process Engineers",
            desc: "Analyze and optimize workflows to identify automation opportunities."
        },
        role3: {
            title: "Business Analysts",
            desc: "Bridge the gap between business requirements and technical solutions."
        }
    }
};

translations.en.servicespage = {
    hero: {
        title: "Our Services",
        subtitle: "Comprehensive Business Automation Solutions"
    },
    category1: {
        title: "Sales & Marketing Automation",
        desc: "Transform your sales and marketing processes with intelligent automation that qualifies leads, nurtures prospects, and optimizes conversion rates."
    },
    category2: {
        title: "Operational Efficiency",
        desc: "Streamline internal operations, reduce manual work, and eliminate bottlenecks through process automation."
    },
    category3: {
        title: "Supply Chain & Logistics",
        desc: "Optimize inventory management, order processing, and delivery coordination with smart automation systems."
    },
    flow: {
        title: "Sample Automation Flow",
        item1: "Automated lead capture from multiple channels",
        item2: "Intelligent lead scoring and qualification",
        item3: "Automated routing to appropriate sales team",
        item4: "Follow-up sequences and nurturing campaigns",
        item5: "Performance tracking and optimization"
    },
    flow2: {
        item1: "Process audit and bottleneck identification",
        item2: "Workflow redesign and optimization",
        item3: "Automated task assignment and tracking",
        item4: "Integration with existing systems",
        item5: "Continuous monitoring and improvement"
    },
    flow3: {
        item1: "Automated inventory monitoring and alerts",
        item2: "Order processing and fulfillment automation",
        item3: "Delivery scheduling and tracking",
        item4: "Supplier communication automation",
        item5: "Real-time reporting and analytics"
    },
    cta: {
        title: "Ready to Automate Your Business?",
        text: "Request a consultation to discover how automation can transform your operations.",
        button: "Request Consultation"
    }
};

translations.en.pricingpage = {
    hero: {
        title: "Pricing Plans",
        subtitle: "Choose the automation solution that fits your business needs"
    },
    toggle: {
        monthly: "Monthly",
        annual: "Annual"
    },
    enterprise: {
        cta: "Schedule Meeting"
    }
};

translations.en.contactpage = {
    hero: {
        title: "Get Started Today",
        subtitle: "Let's discuss how automation can transform your business"
    }
};


// Current Language
let currentLang = localStorage.getItem('language') || 'en';

// Initialize
document.addEventListener('DOMContentLoaded', function () {
    initIntroOverlay();
    initLanguage();
    initNavigation();
    initAnimations();
    initCursorParallax();
    // initHeroParticles();
    initSectionParallax();
    initForms();
    initPricingInteractions();
    initRealtimeValidation();
    if (window.UserState) {
        window.UserState.syncForms();
        window.UserState.listen();
    }
    setTimezone();

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = Math.floor(width * DPR);
        canvas.height = Math.floor(height * DPR);
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }

});

/* function initHeroParticles() {
    if (window.__globalParticlesActive) return; // avoid double layers
    const canvas = document.getElementById('heroCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let width, height, particles;
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
    const colors = ['#7AF1FF', '#8B63FF', '#FF6FD8'];
    const PCOUNT = 48;
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = Math.floor(width * DPR);
        canvas.height = Math.floor(height * DPR);
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    function init() {
        particles = Array.from({ length: PCOUNT }).map(() => ({
            x: Math.random() * width,
            y: Math.random() * height,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            r: Math.random() * 2 + 0.6,
            c: colors[Math.floor(Math.random() * colors.length)]
        }));
    }
    function step() {
        ctx.clearRect(0, 0, width, height);
        // draw connections
        for (let i = 0; i < particles.length; i++) {
            const p = particles[i];
            for (let j = i + 1; j < particles.length; j++) {
                const q = particles[j];
                const dx = p.x - q.x;
                const dy = p.y - q.y;
                const d = Math.hypot(dx, dy);
                if (d < 120) {
                    const alpha = 1 - d / 120;
                    ctx.strokeStyle = `rgba(138, 99, 255, ${alpha * 0.25})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(q.x, q.y);
                    ctx.stroke();
                }
            }
        }
        // draw particles
        for (const p of particles) {
            ctx.fillStyle = p.c;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < -20) p.x = width + 20;
            if (p.x > width + 20) p.x = -20;
            if (p.y < -20) p.y = height + 20;
            if (p.y > height + 20) p.y = -20;
        }
        requestAnimationFrame(step);
    }
    resize();
    init();
    step();
    window.addEventListener('resize', () => {
        resize();
        init();
    });
    window.__globalParticlesActive = true; // Prevent double initialization
} */

// Subtle particle network in hero
/* function initHeroParticles() {
    if (window.__globalParticlesActive) return; // avoid double layers
    const canvas = document.getElementById('heroCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let width, height, particles;
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
    const colors = ['#7AF1FF', '#8B63FF', '#FF6FD8'];
    const PCOUNT = 48;
    function resize() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = Math.floor(width * DPR);
        canvas.height = Math.floor(height * DPR);
        ctx.scale(DPR, DPR);
    }
    function init() {
        particles = Array.from({ length: PCOUNT }).map(() => ({
            x: Math.random() * width,
            y: Math.random() * height,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            r: Math.random() * 2 + 0.6,
            c: colors[Math.floor(Math.random() * colors.length)]
        }));
    }
    function step() {
        ctx.clearRect(0, 0, width, height);
        // draw connections
        for (let i = 0; i < particles.length; i++) {
            const p = particles[i];
            for (let j = i + 1; j < particles.length; j++) {
                const q = particles[j];
                const dx = p.x - q.x;
                const dy = p.y - q.y;
                const d = Math.hypot(dx, dy);
                if (d < 120) {
                    const alpha = 1 - d / 120;
                    ctx.strokeStyle = `rgba(138, 99, 255, ${alpha * 0.25})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(q.x, q.y);
                    ctx.stroke();
                }
            }
        }
        // draw particles
        for (const p of particles) {
            ctx.fillStyle = p.c;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < -20) p.x = width + 20;
            if (p.x > width + 20) p.x = -20;
            if (p.y < -20) p.y = height + 20;
            if (p.y > height + 20) p.y = -20;
        }
        requestAnimationFrame(step);
    }
    resize();
    init();
    window.addEventListener('resize', () => {
        resize();
        init();
    });
    window.__globalParticlesActive = true; // Prevent double initialization
    
    // Sync language with SessionStorage for chatbot consistency
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const lang = btn.getAttribute('data-lang');
            sessionStorage.setItem('chatLang', lang);
        });
    });
} */

// Language Toggle
function initLanguage() {
    const langButtons = document.querySelectorAll('.lang-btn');

    langButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const lang = btn.getAttribute('data-lang');
            setLanguage(lang);
        });
    });

    setLanguage(currentLang);
}

function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    sessionStorage.setItem('chatLang', lang);
    // Update active button
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
    });

    // Update all translatable elements
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const keys = key.split('.');
        let value = translations[lang];

        for (let k of keys) {
            value = value?.[k];
        }

        if (value) {
            if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                el.placeholder = value;
            } else {
                el.innerHTML = value;
            }
        }
    });

    // Update meta title
    if (lang === 'sk') {
        document.title = 'ArciGy — Automatizácia Procesov | Architekti Efektivity';
    } else {
        document.title = 'ArciGy — Business Process Automation | Efficiency Architects';
    }

    // --- Calendar Language Sync ---
    // If the calendar has been opened, re-render it to reflect the new language
    if (window.arcigyCalendar && typeof window.arcigyCalendar.updateLanguage === 'function') {
        window.arcigyCalendar.updateLanguage(lang);
    }

    // --- Cookie Consent Language Sync ---
    if (typeof window.updateCookieConsentLanguage === 'function') {
        window.updateCookieConsentLanguage(lang);
    }
}

// Navigation
function initNavigation() {
    const navToggle = document.getElementById('navToggle');
    const navMenu = document.getElementById('navMenu');
    const navLinks = document.querySelectorAll('.nav-link');

    if (navToggle && navMenu) {
        navToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            navToggle.classList.toggle('active');
        });
    }

    // Close menu on link click (mobile)
    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                navMenu.classList.remove('active');
                navToggle.classList.remove('active');
            }
        });
    });

    // Sticky navbar
    const navbar = document.getElementById('navbar');
    if (navbar) {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                navbar.style.background = 'rgba(5, 8, 18, 0.95)';
            } else {
                navbar.style.background = 'rgba(5, 8, 18, 0.8)';
            }
        });
    }
}

// Scroll Animations
function initAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            } else {
                // Remove visible class when out of view to re-trigger animation
                entry.target.classList.remove('visible');
            }
        });
    }, observerOptions);

    // Observe all animatable elements
    document.querySelectorAll('.problem-card, .service-item, .process-step, .pricing-card, .testimonial-card, .value-card, .team-card, .blog-card, .position-card, .step-card').forEach(el => {
        observer.observe(el);
    });

    // Removed scroll-based parallax for hero shapes (to keep visuals static on scroll)
}

// Section parallax updater (perf-safe with rAF)
function initSectionParallax() {
    // Disable background parallax on scroll; keep background static
    document.documentElement.style.setProperty('--bg-parallax', `0px`);
}

// Cursor parallax for gradients
function initCursorParallax() {
    const root = document.documentElement;
    window.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth - 0.5) * 40; // -20..20
        const y = (e.clientY / window.innerHeight - 0.5) * 40; // -20..20
        root.style.setProperty('--parallax-x', `${x}px`);
        root.style.setProperty('--parallax-y', `${y}px`);
    });
}

// Subtle particle network in hero
/* function initHeroParticles() {
    if (window.__globalParticlesActive) return; // avoid double layers
    const canvas = document.getElementById('heroCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let width, height, particles;
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
    const colors = ['#7AF1FF', '#8B63FF', '#FF6FD8'];
    const PCOUNT = 48;
    function resize() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = Math.floor(width * DPR);
        canvas.height = Math.floor(height * DPR);
        ctx.scale(DPR, DPR);
    }
    function init() {
        particles = Array.from({ length: PCOUNT }).map(() => ({
            x: Math.random() * width,
            y: Math.random() * height,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            r: Math.random() * 2 + 0.6,
            c: colors[Math.floor(Math.random() * colors.length)]
        }));
    }
    function step() {
        ctx.clearRect(0, 0, width, height);
        // draw connections
        for (let i = 0; i < particles.length; i++) {
            const p = particles[i];
            for (let j = i + 1; j < particles.length; j++) {
                const q = particles[j];
                const dx = p.x - q.x;
                const dy = p.y - q.y;
                const d = Math.hypot(dx, dy);
                if (d < 120) {
                    const alpha = 1 - d / 120;
                    ctx.strokeStyle = `rgba(138, 99, 255, ${alpha * 0.25})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(q.x, q.y);
                    ctx.stroke();
                }
            }
        }
        // draw particles
        for (const p of particles) {
            ctx.fillStyle = p.c;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < -20) p.x = width + 20;
            if (p.x > width + 20) p.x = -20;
            if (p.y < -20) p.y = height + 20;
            if (p.y > height + 20) p.y = -20;
        }
        requestAnimationFrame(step);
    }
    resize();
    init();
    step();
    window.addEventListener('resize', () => {
        resize();
        init();
    });
} */

// Global particle background across the entire site
/* function initGlobalParticles() {
    if (window.__globalParticlesActive) return;
    const canvas = document.createElement('canvas');
    canvas.id = 'globalParticles';
    canvas.style.cssText = 'position:fixed;inset:0;z-index:-3;pointer-events:none;opacity:0.28;filter:blur(0.15px);';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    window.__globalParticlesActive = true;
    let width, height, particles;
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
    const colors = ['#7AF1FF', '#8B63FF', '#FF6FD8'];
    const PCOUNT = Math.max(64, Math.floor((window.innerWidth * window.innerHeight) / 25000));
    function resize() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = Math.floor(width * DPR);
        canvas.height = Math.floor(height * DPR);
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    function init() {
        particles = Array.from({ length: PCOUNT }).map(() => ({
            x: Math.random() * width,
            y: Math.random() * height,
            vx: (Math.random() - 0.5) * 0.25,
            vy: (Math.random() - 0.5) * 0.25,
            r: Math.random() * 1.8 + 0.5,
            c: colors[Math.floor(Math.random() * colors.length)]
        }));
    }
    function step() {
        ctx.clearRect(0, 0, width, height);
        // gentle connections
        for (let i = 0; i < particles.length; i++) {
            const p = particles[i];
            for (let j = i + 1; j < particles.length; j++) {
                const q = particles[j];
                const dx = p.x - q.x;
                const dy = p.y - q.y;
                const d = Math.hypot(dx, dy);
                if (d < 110) {
                    const alpha = 1 - d / 110;
                    ctx.strokeStyle = `rgba(122, 241, 255, ${alpha * 0.18})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(q.x, q.y);
                    ctx.stroke();
                }
            }
        }
        // particles
        for (const p of particles) {
            ctx.fillStyle = p.c;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < -20) p.x = width + 20;
            if (p.x > width + 20) p.x = -20;
            if (p.y < -20) p.y = height + 20;
            if (p.y > height + 20) p.y = -20;
        }
        requestAnimationFrame(step);
    }
    resize();
    init();
    step();
    window.addEventListener('resize', () => {
        resize();
        init();
    });
} */

// Email Validation Helper
async function validateEmailWithBackend(email) {
    if (!email) return { valid: false, message: 'Prosím zadajte email.' };

    // 1. Basic Frontend Regex Check (Immediate)
    const emailRegex = /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;
    if (!emailRegex.test(email)) {
        return {
            valid: false,
            message: (typeof currentLang !== 'undefined' && currentLang === 'sk') ? 'Neplatný formát e-mailu.' : 'Invalid email format.'
        };
    }

    // 2. Determine Backend URL
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const DEFAULT_BACKEND_URL = isLocal ? 'http://localhost:8000' : 'https://my-website-backend-production-25c8.up.railway.app';
    const BACKEND_URL = window.ARCIGY_BACKEND_URL || DEFAULT_BACKEND_URL;

    try {
        const lang = (typeof currentLang !== 'undefined') ? currentLang : 'en';
        const response = await fetch(`${BACKEND_URL}/webhook/verify-email?email=${encodeURIComponent(email)}&lang=${lang}`);
        if (!response.ok) throw new Error('Validation service error');
        return await response.json();
    } catch (e) {
        console.warn('⚠️ Email validation service unreachable.', e);
        return { valid: true };
    }
}
window.validateEmailWithBackend = validateEmailWithBackend;

function showError(input, message, suggestion = null) {
    input.classList.add('input-error');
    let errorEl = input.parentElement.querySelector('.error-message');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.className = 'error-message';
        input.parentElement.appendChild(errorEl);
    }

    // Disable submit button of the parent form and change text
    const form = input.closest('form');
    if (form) {
        const btn = form.querySelector('button[type="submit"]');
        if (btn) {
            if (!btn.hasAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', btn.textContent);
            }
            btn.disabled = true;
            const lang = (typeof currentLang !== 'undefined') ? currentLang : (localStorage.getItem('language') || 'en');
            btn.textContent = lang === 'sk' ? 'Prosím, opravte chybu' : 'Please fix error';
        }
    }

    if (suggestion) {
        const lang = (typeof currentLang !== 'undefined') ? currentLang : (localStorage.getItem('language') || 'en');
        const msg = lang === 'sk' ? `Mysleli ste ` : `Did you mean `;
        errorEl.innerHTML = `<span>⚠️ ${msg}</span> <span class="suggestion-link" title="${lang === 'sk' ? 'Použiť tento e-mail' : 'Use this email'}">${suggestion}</span>?`;
        errorEl.querySelector('.suggestion-link').onclick = () => {
            input.value = suggestion;
            clearError(input);
            // Re-trigger UserState update and validation
            input.dispatchEvent(new Event('input'));
            input.dispatchEvent(new Event('blur'));
        };
    } else {
        errorEl.innerHTML = `<span>⚠️ ${message}</span>`;
    }
    errorEl.classList.add('active');
}
window.showError = showError;

function clearError(input) {
    input.classList.remove('input-error');
    const errorEl = input.parentElement.querySelector('.error-message');
    if (errorEl) errorEl.classList.remove('active');

    // Re-enable submit button if no other errors in the form
    const form = input.closest('form');
    if (form) {
        const hasErrors = form.querySelectorAll('.input-error').length > 0;
        if (!hasErrors) {
            const btn = form.querySelector('button[type="submit"]');
            if (btn && btn.hasAttribute('data-original-text')) {
                btn.disabled = false;
                btn.textContent = btn.getAttribute('data-original-text');
                btn.removeAttribute('data-original-text');
            }
        }
    }
}
window.clearError = clearError;

// Forms
function initForms() {
    const contactForm = document.getElementById('contactForm');
    const newsletterForm = document.getElementById('newsletterForm');
    const emailForm = document.getElementById('emailForm');

    async function handleFormSubmit(form, webhookUrl, successMsgSk, successMsgEn) {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // 1. Find email input
        const emailInput = form.querySelector('input[type="email"]');
        if (emailInput) {
            clearError(emailInput);
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = (currentLang === 'sk' ? 'Overujem...' : 'Verifying...');

                const validation = await validateEmailWithBackend(emailInput.value);

                if (!validation.valid) {
                    showError(emailInput, validation.message, validation.suggestion);
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return; // STOP SUBMISSION
                }
                btn.textContent = originalText; // Reset text for actual submission
            }
        }

        // 2. Normal submission
        try {
            data.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Bratislava';
        } catch (e) {
            data.timezone = 'Europe/Bratislava';
        }
        data.language = currentLang;

        const url = new URL(webhookUrl);
        Object.keys(data).forEach(key => url.searchParams.append(key, data[key]));

        fetch(url, { method: 'GET' })
            .then(response => {
                if (response.ok) {
                    alert(currentLang === 'sk' ? successMsgSk : successMsgEn);
                    form.reset();
                    if (window.UserState) window.UserState.update({}); // Reset state
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(currentLang === 'sk' ? 'Došlo k chybe. Skúste to prosím neskôr.' : 'An error occurred. Please try again later.');
            })
            .finally(() => {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) btn.disabled = false;
            });
    }

    if (contactForm) {
        contactForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleFormSubmit(
                contactForm,
                'https://n8n.srv1118451.hstgr.cloud/webhook-test/c67d2d9c-9c97-4e89-990a-633171bebe19',
                'Ďakujeme za váš záujem! Čoskoro vás budeme kontaktovať.',
                'Thank you for your interest! We will contact you soon.'
            );
        });
    }

    if (emailForm) {
        emailForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleFormSubmit(
                emailForm,
                'https://n8n.srv1118451.hstgr.cloud/webhook-test/71b23cfc-169d-45c6-803d-7229dccf6a04',
                'Ďakujeme za váš email! Čoskoro vás budeme kontaktovať.',
                'Thank you for your email! We will contact you soon.'
            );
        });
    }

    if (newsletterForm) {
        newsletterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleFormSubmit(
                newsletterForm,
                'https://n8n.srv1118451.hstgr.cloud/webhook-test/newsletter-placeholder',
                'Ďakujeme za prihlásenie sa!',
                'Thank you for subscribing!'
            );
        });
    }
}

function initRealtimeValidation() {
    const emailInputs = document.querySelectorAll('input[type="email"]');
    emailInputs.forEach(input => {
        // Validation on blur
        input.addEventListener('blur', async () => {
            if (input.value) {
                // Show immediate "verifying" state? No, just fast check
                const validation = await validateEmailWithBackend(input.value);
                if (!validation.valid) {
                    showError(input, validation.message, validation.suggestion);
                } else {
                    clearError(input);
                }
            }
        });

        // Immediate clear on typing to keep it responsive
        input.addEventListener('input', () => {
            if (input.classList.contains('input-error')) {
                clearError(input);
            }
        });
    });
}

// Set Timezone
function setTimezone() {
    try {
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        // Default to Europe/Bratislava if not detected
        const defaultTz = 'Europe/Bratislava';
        // You can use this timezone info when submitting forms
        console.log('Timezone:', timezone || defaultTz);
    } catch (e) {
        console.log('Timezone: Europe/Bratislava (default)');
    }
}



// Intro Overlay Logic
function initIntroOverlay() {
    const overlay = document.getElementById('Intro_Overlay');
    if (!overlay) return;

    // Check session
    const hasSeenIntro = sessionStorage.getItem('introShown');
    if (hasSeenIntro === 'true') {
        overlay.style.display = 'none';
        return;
    }

    // Lock scroll
    document.body.style.overflow = 'hidden';

    // Animation Sequence
    // 0s: Start (overlay is visible, parts are opacity: 0)

    // Beat 1: Text Fade In (Start at 0.5s)
    setTimeout(() => {
        const textPaths = overlay.querySelectorAll('.path-text');
        textPaths.forEach((path, index) => {
            // Stagger slightly for effect if desired, but request says "Target all elements... Fade them in"
            // We'll add the class directly.
            path.classList.add('anim-text');
        });
    }, 200);

    // Beat 2: Left Bracket (Start at 1.5s -> 0.6s)
    setTimeout(() => {
        const leftBracket = overlay.querySelector('.path-symbol-left');
        if (leftBracket) leftBracket.classList.add('anim-symbol');
    }, 600);

    // Beat 3: Slash (Start at 2.0s -> 0.8s)
    setTimeout(() => {
        const slash = overlay.querySelector('.path-symbol-slash');
        if (slash) slash.classList.add('anim-symbol');
    }, 800);

    // Beat 4: Right Bracket (Start at 2.5s -> 1.0s)
    setTimeout(() => {
        const rightBracket = overlay.querySelector('.path-symbol-right');
        if (rightBracket) rightBracket.classList.add('anim-symbol');
    }, 1000);

    // End: Fade Out (Start at 4.0s -> 1.5s)
    setTimeout(() => {
        overlay.classList.add('fade-out');
        document.body.style.overflow = ''; // Unlock scroll

        // Mark session
        sessionStorage.setItem('introShown', 'true');

        // Remove from DOM after transition
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 500);
    }, 1500);
}

// Pricing Button Interactions
function initPricingInteractions() {
    const buttons = document.querySelectorAll('.js-pricing-plan-cta');

    buttons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            // Check if warning has been shown in this session
            const hasWarned = sessionStorage.getItem('audit_warning_shown');

            if (!hasWarned) {
                e.preventDefault(); // Stop navigation

                // Set flag so next click works
                sessionStorage.setItem('audit_warning_shown', 'true');

                // Trigger chatbot warning
                if (typeof window.triggerPricingWarning === 'function') {
                    window.triggerPricingWarning(currentLang);
                } else {
                    console.warn('Chatbot warning function not found');
                }
            }
            // If hasWarned is true, we do nothing and let the default link behavior happen (navigation)
        });
    });
}

// --- User State Manager ---
const UserStateManager = {
    get: function () {
        try {
            return JSON.parse(localStorage.getItem('userState')) || {};
        } catch (e) {
            return {};
        }
    },

    update: function (data) {
        const current = this.get();
        const filtered = {};
        Object.keys(data).forEach(key => {
            if (data[key] !== null && data[key] !== "null" && data[key] !== "") {
                filtered[key] = data[key];
            }
        });
        const updated = { ...current, ...filtered };
        localStorage.setItem('userState', JSON.stringify(updated));
        this.syncForms(); // Update UI immediately
        return updated;
    },

    syncForms: function () {
        const state = this.get();
        const inputs = document.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            const name = input.name || input.id;
            if (!name) return;

            // 1. Direct match (e.g. email, phone, company, turnover, subject, letter)
            if (state[name] !== undefined && document.activeElement !== input) {
                input.value = state[name];
            }

            // 2. Map canonical fullName to various field names
            const fullNameSelectors = ['fullname', 'full_name'];
            if (state.fullName && fullNameSelectors.includes(name) && document.activeElement !== input) {
                input.value = state.fullName;
            }

            // 3. Split fullName to forename/surname if needed
            if (state.fullName && (name === 'forename' || name === 'surname')) {
                const parts = state.fullName.split(' ');
                if (document.activeElement !== input) {
                    if (name === 'forename') input.value = parts[0] || '';
                    if (name === 'surname') input.value = parts.slice(1).join(' ') || '';
                }
            }

            // --- ADDED: Trigger validation if value was populated ---
            if (input.value && document.activeElement !== input) {
                // If it's an email field, trigger blur to run validation
                if (input.type === 'email' || name.includes('email')) {
                    input.dispatchEvent(new Event('blur'));
                }
            }
        });
    },

    listen: function () {
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const name = e.target.name || e.target.id;
                if (!name || e.target.type === 'password') return;

                let update = {};

                // Capture value
                if (name === 'fullname' || name === 'full_name') {
                    update.fullName = e.target.value;
                } else if (name === 'forename' || name === 'surname') {
                    const f = document.querySelector('[name="forename"], #forename')?.value || '';
                    const s = document.querySelector('[name="surname"], #surname')?.value || '';
                    update.fullName = (f + ' ' + s).trim();
                } else {
                    update[name] = e.target.value;
                }

                if (Object.keys(update).length > 0) {
                    const current = this.get();
                    const merged = { ...current, ...update };
                    localStorage.setItem('userState', JSON.stringify(merged));
                }
            });
        });
    },

    clearLegacy: function () {
        // Cleanup old trash
        const keys = ['userName', 'userEmail', 'userPhone', 'forename', 'surname'];
        keys.forEach(k => {
            localStorage.removeItem(k);
            sessionStorage.removeItem(k);
        });
    }
};

// Expose globally
window.UserState = UserStateManager;

// Auto-init only if we are in the main execution context 
// (The DOMContentLoaded listener at the top also calls this, but we ensure the object exists first)
UserStateManager.clearLegacy(); // Clean up old trash
UserStateManager.syncForms();
UserStateManager.listen();
